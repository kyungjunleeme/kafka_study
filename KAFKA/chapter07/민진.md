- ì°¸ê³  ë§í¬: https://shinminjin.github.io/posts/chapter07/


# **(ì¥ì• ìƒí™© 1) í´ë¼ì´ì–¸íŠ¸ê°€ ë¸Œë¡œì»¤ ì¤‘ í•˜ë‚˜ì™€ ì—°ê²°ì´ ëŠì–´ì§ âš¡**

## **1. ì‹œë‚˜ë¦¬ì˜¤ í™˜ê²½ì„¤ì • ğŸ› ï¸**

- **ì¹´í”„ì¹´ ë¸Œë¡œì»¤1(`kafka-docker-kafka-1`)** : `localhost:9092`
- **ì¹´í”„ì¹´ ë¸Œë¡œì»¤2(`kafka-docker-kafka2-1`)** : `localhost:9093`
- **í”„ë¡œë“€ì„œ**: í´ëŸ¬ìŠ¤í„°ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡
- **ì»¨ìŠˆë¨¸**: í´ëŸ¬ìŠ¤í„°ì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ 

## **2. ì‹œë‚˜ë¦¬ì˜¤1: ì •ìƒì ì¸ ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  ğŸ“¨**

1. í”„ë¡œë“€ì„œê°€ `localhost:9092` ë˜ëŠ” `localhost:9093` ë¸Œë¡œì»¤ë¡œ ì—°ê²°í•˜ì—¬ ë©”ì‹œì§€ ì „ì†¡
2. ë©”ì‹œì§€ëŠ” ì¹´í”„ì¹´ ë¸Œë¡œì»¤ì—ì„œ ì²˜ë¦¬ë˜ê³ , ì»¨ìŠˆë¨¸ëŠ” í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ë‹¤ë¥¸ ë¸Œë¡œì»¤ì—ì„œ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì‹ í•¨
3. ì´ë•Œ, ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ëŠ” ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë©°, ë©”ì‹œì§€ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ ëª¨ë“  ë¸Œë¡œì»¤ì—ì„œ ì ì ˆí•˜ê²Œ ì²˜ë¦¬

## **3. ì‹œë‚˜ë¦¬ì˜¤2: ì¹´í”„ì¹´ ë¸Œë¡œì»¤1(`kafka-docker-kafka-1`) ì¥ì•  ë°œìƒ ğŸš«**

1. `localhost:9092`ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ `kafka-docker-kafka-1` ì»¨í…Œì´ë„ˆê°€ ì¥ì• ê°€ ë°œìƒí•˜ê±°ë‚˜ ì¢…ë£Œë¨
2. í”„ë¡œë“€ì„œì™€ ì»¨ìŠˆë¨¸ëŠ” ì—¬ì „íˆ `localhost:9093` ë¸Œë¡œì»¤ì— ì—°ê²°í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŒ
3. ë©”íƒ€ë°ì´í„° ê°±ì‹ ì´ ì´ë£¨ì–´ì ¸ í´ë¼ì´ì–¸íŠ¸ëŠ” ìƒˆë¡œìš´ ë¸Œë¡œì»¤ ì •ë³´ë¥¼ ì¸ì‹í•˜ê³ , ì¥ì• ê°€ ë°œìƒí•œ ë¸Œë¡œì»¤ë¥¼ ì œì™¸í•œ ìƒíƒœì—ì„œ ì •ìƒì ìœ¼ë¡œ ì‘ì—…ì„ ê³„ì†í•  ìˆ˜ ìˆìŒ
4. ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ëŠ” ì¥ì• ê°€ ë°œìƒí•œ ë¸Œë¡œì»¤ì˜ íŒŒí‹°ì…˜ ë¦¬ë”ë¥¼ `localhost:9093`ì— ìˆëŠ” ë¸Œë¡œì»¤ë¡œ ì „í™˜í•¨
5. ì´ë¡œì¨ í´ëŸ¬ìŠ¤í„°ëŠ” ì¥ì•  ë°œìƒ í›„ì—ë„ ì •ìƒì ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ

## **4. ì‹œë‚˜ë¦¬ì˜¤ 3: ì¹´í”„ì¹´ ë¸Œë¡œì»¤ 1 ë³µêµ¬ ğŸ”„**

1. `localhost:9092`ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ `kafka-docker-kafka-1` ì»¨í…Œì´ë„ˆê°€ ë³µêµ¬ë˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œì‘ë¨
2. í´ë¼ì´ì–¸íŠ¸ëŠ” `localhost:9092` ë¸Œë¡œì»¤ë¥¼ ë‹¤ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë˜ë©°, ë©”ì‹œì§€ ì „ì†¡ê³¼ ìˆ˜ì‹ ì´ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§
3. ë³µêµ¬ëœ ë¸Œë¡œì»¤ëŠ” ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ì˜ ì¼ë¶€ë¡œ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì°¸ì—¬í•¨

## **5. ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìœ„í•œ í™˜ê²½ êµ¬ì„± âš™ï¸**

### **1. ë°ì´í„° ì´ˆê¸°í™”**

```bash
docker-compose down -v
```

### **2. `docker-compose.yml` íŒŒì¼**

```bash
vi docker-compose.yml
```

```yaml
services:
  kafka:
    image: docker.io/bitnami/kafka:3.9
    ports:
      - "9092:9092"
    volumes:
      - "kafka_data:/bitnami"
    environment:
      # KRaft settings
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093,1@kafka2:9093
      - KAFKA_KRAFT_CLUSTER_ID=my-cluster-id  # ë™ì¼í•œ í´ëŸ¬ìŠ¤í„° ID ì„¤ì •
      # Listeners
      - KAFKA_CFG_LISTENERS=PLAINTEXT://kafka:9092,CONTROLLER://kafka:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT

  kafka2:
    image: docker.io/bitnami/kafka:3.9
    ports:
      - "9093:9092"
    volumes:
      - "kafka_data2:/bitnami"
    environment:
      # KRaft settings
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker  # kafka2ë„ controllerì™€ broker ì—­í• ì„ ìˆ˜í–‰
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093,1@kafka2:9093
      - KAFKA_KRAFT_CLUSTER_ID=my-cluster-id  # ë™ì¼í•œ í´ëŸ¬ìŠ¤í„° ID ì„¤ì •
      # Listeners
      - KAFKA_CFG_LISTENERS=PLAINTEXT://kafka2:9092,CONTROLLER://kafka2:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER

volumes:
  kafka_data:
    driver: local
  kafka_data2:
    driver: local
```

### **3. ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘**

```bash
docker-compose up -d
```

**docker ps ê²°ê³¼**

```bash
[shin@gram88 kafka-docker]$ docker ps
CONTAINER ID   IMAGE               COMMAND                  CREATED       STATUS         PORTS                                         NAMES
6556e25e5562   bitnami/kafka:3.9   "/opt/bitnami/scriptâ€¦"   2 hours ago   Up 2 minutes   0.0.0.0:9092->9092/tcp, :::9092->9092/tcp     kafka-docker-kafka-1
2482d4a57dba   bitnami/kafka:3.9   "/opt/bitnami/scriptâ€¦"   2 hours ago   Up 2 hours     0.0.0.0:9093->9092/tcp, [::]:9093->9092/tcp   kafka-docker-kafka2-1
```

### **4. ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ í”„ë¡œì íŠ¸ êµ¬ì„±í•˜ê¸°**

**`KafkaConfig`**

```java
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.common.serialization.StringDeserializer;
import org.apache.kafka.common.serialization.StringSerializer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.annotation.EnableKafka;
import org.springframework.kafka.core.DefaultKafkaProducerFactory;
import org.springframework.kafka.core.KafkaTemplate;

import java.util.HashMap;
import java.util.Map;

@Configuration
@EnableKafka
public class KafkaConfig {

    @Bean
    public Map<String, Object> producerConfig() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");  // Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        return configProps;
    }

    @Bean
    public KafkaTemplate<String, String> kafkaTemplate() {
        return new KafkaTemplate<>(new DefaultKafkaProducerFactory<>(producerConfig()));
    }

    @Bean
    public Map<String, Object> consumerConfig() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");  // Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ
        configProps.put(ConsumerConfig.GROUP_ID_CONFIG, "my-group");
        configProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        configProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        return configProps;
    }

    @Bean
    public KafkaConsumer<String, String> consumer() {
        return new KafkaConsumer<>(consumerConfig());
    }
}
```

**`KafkaConsumer`**

```java
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Service;

@Service
public class KafkaConsumer {

    @KafkaListener(topics = "my_topic", groupId = "my-group")
    public void listen(String message) {
        System.out.println("Received message: " + message);
    }
}
```

**`KafkaProducer`**

```java
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.clients.producer.RecordMetadata;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.kafka.support.ProducerListener;
import org.springframework.kafka.support.SendResult;
import org.springframework.stereotype.Service;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;

@Service
public class KafkaProducer {

    private final KafkaTemplate<String, String> kafkaTemplate;

    @Autowired
    public KafkaProducer(KafkaTemplate<String, String> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;

        // ProducerListener ì„¤ì •
        kafkaTemplate.setProducerListener(new ProducerListener<String, String>() {

            @Override
            public void onSuccess(ProducerRecord<String, String> producerRecord, RecordMetadata recordMetadata) {
                // ì „ì†¡ ì„±ê³µ ì‹œ, RecordMetadataë¥¼ í†µí•´ ì „ì†¡ëœ ë°ì´í„°ì˜ ë©”íƒ€ ì •ë³´ë¥¼ í™•ì¸
                String topic = recordMetadata.topic();
                int partition = recordMetadata.partition();
                long offset = recordMetadata.offset();
                System.out.println("Message successfully sent to topic: " + topic + ", partition: " + partition + ", offset: " + offset);
            }

            @Override
            public void onError(ProducerRecord<String, String> producerRecord, RecordMetadata recordMetadata, Exception exception) {
                // ì „ì†¡ ì‹¤íŒ¨ ì‹œ, ì˜ˆì™¸ ë©”ì‹œì§€ ì¶œë ¥
                System.out.println("Failed to send message to topic: " + producerRecord.topic() + ". Exception: " + exception.getMessage());
                System.out.println("Failed message: " + producerRecord.value()); // ì‹¤íŒ¨í•œ ë©”ì‹œì§€ ì¶œë ¥
            }
        });
    }

    public void sendMessage(String message) {
        long startTime = System.currentTimeMillis();
        CompletableFuture<SendResult<String, String>> future = CompletableFuture.supplyAsync(() -> {
            try {
                // ë©”ì‹œì§€ ì „ì†¡
                return kafkaTemplate.send("my_topic", "key", message).get();  // blocking
            } catch (InterruptedException | ExecutionException e) {
                // ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ ì²˜ë¦¬
                throw new RuntimeException("Failed to send message", e);
            }
        });

        future.whenComplete((result, ex) -> {
            long endTime = System.currentTimeMillis();
            if (ex == null) {
                System.out.println("Message sent successfully in " + (endTime - startTime) + " ms");
            } else {
                // ì§€ì—°ì´ë‚˜ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ ì²˜ë¦¬
                System.out.println("Failed to send message in " + (endTime - startTime) + " ms: " + ex.getMessage());
                // ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
            }
        });
    }
}

```

**`KafkaController`**

```java
import com.example.errorhandling.producer.KafkaProducer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class KafkaController {

    private final KafkaProducer kafkaProducer;

    @Autowired
    public KafkaController(KafkaProducer kafkaProducer) {
        this.kafkaProducer = kafkaProducer;
    }

    @GetMapping("/sendMessage")
    public String sendMessage() {
        kafkaProducer.sendMessage("Hello, Kafka!"); // Kafkaë¡œ ë©”ì‹œì§€ ì „ì†¡
        return "Message sent to Kafka!";
    }
}

```

**`application.yml`**

```yaml
server:
  port: 8080

spring:
  kafka:
    bootstrap-servers: localhost:9092,localhost:9093  # ë‹¤ì¤‘ ë¸Œë¡œì»¤ ì„¤ì •
    consumer:
      group-id: my-group
      auto-offset-reset: earliest
      session.timeout.ms: 1000  # ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ 1ì´ˆ ì„¤ì •
      heartbeat.interval.ms: 500  # í•˜íŠ¸ë¹„íŠ¸ ê°„ê²© 500ms ì„¤ì •
      max.poll.interval.ms: 1000  # í´ë§ ëŒ€ê¸° ì‹œê°„ 1ì´ˆ
      metadata-max-age-ms: 30000  # 30ì´ˆë§ˆë‹¤ ë©”íƒ€ë°ì´í„° ê°±ì‹ 
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      acks: all
      retries: 3
      request.timeout.ms: 1500  # ìš”ì²­ íƒ€ì„ì•„ì›ƒ 1.5ì´ˆ ì„¤ì •
      max.block.ms: 1500  # ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ 1.5ì´ˆ ì„¤ì •
      reconnect.backoff.ms: 500
      reconnect.backoff.max.ms: 2000
      retry.backoff.ms: 500
      metadata-max-age-ms: 30000  # 30ì´ˆë§ˆë‹¤ ë©”íƒ€ë°ì´í„° ê°±ì‹ 
```

## **6. ì‹œë‚˜ë¦¬ì˜¤1 ì‹¤í–‰ - ì •ìƒì ì¸ ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  ğŸ“©**

**Postmanì„ í™œìš©í•´ `/sendMessage` ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œ**

![postman](https://github.com/user-attachments/assets/027675fb-1099-48a4-8dd3-6ee65d4acb42)

**ë©”ì‹œì§€ ì •ìƒ ì²˜ë¦¬**

![result1](https://github.com/user-attachments/assets/3fd48c3d-544a-44dc-b11e-ffe8ebe1924e)

## **7. ì‹œë‚˜ë¦¬ì˜¤2 ì‹¤í–‰ - ì¹´í”„ì¹´ ë¸Œë¡œì»¤1 ì¥ì•  ë°œìƒ ğŸ’¥**

```bash
[shin@gram88 kafka-docker]$ docker stop kafka-docker-kafka-1
```

**ì˜ˆìƒê²°ê³¼**

- í”„ë¡œë“€ì„œ, ì»¨ìŠˆë¨¸ëŠ” ì—¬ì „íˆ `localhost:9093` ë¸Œë¡œì»¤ì— ì—°ê²°ë˜ì–´ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?
- ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ, `localhost:9093` ë¸Œë¡œì»¤ê°€ ìƒˆë¡œìš´ íŒŒí‹°ì…˜ ë¦¬ë” ì—­í• ì„ ìˆ˜í–‰í•˜ì§€ ì•Šì„ê¹Œ?

**ê¸°ëŒ€ì™€ ë‹¤ë¥¸ ê²°ê³¼**

- `localhost:9092`ê°€ ì¥ì• ë¥¼ ì¼ìœ¼í‚¤ë©´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ë¸Œë¡œì»¤ì™€ ì—°ê²°í•  ìˆ˜ ì—†ê²Œ ë˜ì—ˆìŒ
- `localhost:9093` ë¸Œë¡œì»¤ë¡œì˜ ìë™ ì „í™˜ì´ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŒ

![result2](https://github.com/user-attachments/assets/59ba6362-3baf-4f52-9517-10b5df4f6c74)

**ê¸°ëŒ€ì™€ ë‹¤ë¥¸ ê²°ê³¼ê°€ ë°œìƒí•œ ì›ì¸ ë¶„ì„ (ì¶”ì¸¡ ğŸ¤”)**

- **ë©”íƒ€ë°ì´í„° ê°±ì‹  ì§€ì—°**
  - í´ë¼ì´ì–¸íŠ¸ê°€ ì¥ì•  ë¸Œë¡œì»¤ë¥¼ ê°ì§€í•œ í›„ ë‹¤ë¥¸ ë¸Œë¡œì»¤ë¡œ ì „í™˜í•˜ë ¤ë©´ ìµœì‹  ë©”íƒ€ë°ì´í„°ê°€ í•„ìš”í•¨
  - ì¥ì• ë¡œ ì¸í•´ ë©”íƒ€ë°ì´í„° ê°±ì‹  ìš”ì²­ì´ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ë„ ìˆìŒ

- **íŒŒí‹°ì…˜ ë¦¬ë” ì „í™˜ ì‹¤íŒ¨**
  - `localhost:9093`ì´ ìƒˆë¡œìš´ íŒŒí‹°ì…˜ ë¦¬ë”ë¡œ ì „í™˜ë˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ
  - í´ë¼ì´ì–¸íŠ¸ê°€ ìƒˆë¡œìš´ ë¦¬ë” ì •ë³´ë¥¼ ë°›ì§€ ëª»í•´ ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŒ
    - ì´ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë¦¬ë” ì„ ì¶œ ì§€ì—° ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸ ë©”íƒ€ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨ ë•Œë¬¸ì¼ ê°€ëŠ¥ì„± ìˆìŒ


## **8. ì‹œë‚˜ë¦¬ì˜¤3 ì‹¤í–‰ - ì¹´í”„ì¹´ ë¸Œë¡œì»¤1 ë³µêµ¬ ğŸ”§**

```bash
[shin@gram88 kafka-docker]$ docker start kafka-docker-kafka-1
```

**Postmanì„ í™œìš©í•´ `/sendMessage` ì—”ë“œí¬ì¸íŠ¸ ì¬í˜¸ì¶œ**

![postman](https://github.com/user-attachments/assets/027675fb-1099-48a4-8dd3-6ee65d4acb42)

**ë©”ì‹œì§€ ì „ì†¡ê³¼ ìˆ˜ì‹ ì´ ë‹¤ì‹œ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§**

![result3](https://github.com/user-attachments/assets/86e12ae8-9804-434b-9006-fb8cb816a1d6)

# **(ì¥ì• ìƒí™© 2) í´ë¼ì´ì–¸íŠ¸ì™€ ë¸Œë¡œì»¤ ì‚¬ì´ì˜ ê¸´ ì§€ì—° â³**

## **ì‹œë‚˜ë¦¬ì˜¤: ë„¤íŠ¸ì›Œí¬ ì§€ì—°ë°œìƒ (30ì´ˆ) ğŸŒ**

## **1. `docker-compose.yml` ìˆ˜ì • ğŸ“**

**`docker-compose.yml` íŒŒì¼ì—ì„œ `cap_add` í•­ëª©ì„ ì¶”ê°€í•˜ì—¬ `NET_ADMIN` ê¶Œí•œì„ ë¶€ì—¬í•¨**

```yaml
services:
  kafka:
    image: docker.io/bitnami/kafka:3.9
    ports:
      - "9092:9092"
    volumes:
      - "kafka_data:/bitnami"
    environment:
      # KRaft settings
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093,1@kafka2:9093
      - KAFKA_KRAFT_CLUSTER_ID=my-cluster-id  # ë™ì¼í•œ í´ëŸ¬ìŠ¤í„° ID ì„¤ì •
      # Listeners
      - KAFKA_CFG_LISTENERS=PLAINTEXT://kafka:9092,CONTROLLER://kafka:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
    cap_add:
      - NET_ADMIN

  kafka2:
    image: docker.io/bitnami/kafka:3.9
    ports:
      - "9093:9092"
    volumes:
      - "kafka_data2:/bitnami"
    environment:
      # KRaft settings
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker  # kafka2ë„ controllerì™€ broker ì—­í• ì„ ìˆ˜í–‰
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093,1@kafka2:9093
      - KAFKA_KRAFT_CLUSTER_ID=my-cluster-id  # ë™ì¼í•œ í´ëŸ¬ìŠ¤í„° ID ì„¤ì •
      # Listeners
      - KAFKA_CFG_LISTENERS=PLAINTEXT://kafka2:9092,CONTROLLER://kafka2:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    cap_add:
      - NET_ADMIN

volumes:
  kafka_data:
    driver: local
  kafka_data2:
    driver: local

```

## **2. `docker-compose` ì¬ì‹œì‘ ğŸš€**

**íŒŒì¼ì„ ìˆ˜ì •í•œ í›„, `docker-compose`ë¥¼ ì¬ì‹œì‘í•˜ì—¬ ê¶Œí•œì„ ë¶€ì—¬í•œ í›„ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•¨**

```bash
docker-compose down
docker-compose up -d
```

## **3. ì»¨í…Œì´ë„ˆì—ì„œ `tc` ëª…ë ¹ì–´ ì‹¤í–‰ ğŸ–¥ï¸**

**Dockerë¥¼ ì‚¬ìš©í•  ë•Œ `-user=root` ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŒ**

```bash
docker exec -it --user=root kafka-docker-kafka-1 bash
```


**ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì¶”ê°€**: `tc` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì„ ì¶”ê°€í•¨

```bash
root@6556e25e5562:/# apt-get update && apt-get install -y iproute2
root@6556e25e5562:/# tc qdisc add dev eth0 root netem delay 30000ms
```

## **4. KafkaProducerì—ì„œ ì§€ì—° í™•ì¸ ğŸ•’**

**Postmanì„ í™œìš©í•´ `/sendMessage` ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ì—¬ ì§€ì—° ë°œìƒ ì—¬ë¶€ë¥¼ í™•ì¸í•¨**

![postman](https://github.com/user-attachments/assets/027675fb-1099-48a4-8dd3-6ee65d4acb42)

![result4](https://github.com/user-attachments/assets/79d48c40-033a-4bd4-9e08-e3488a33d382)

**`endTime - startTime`ì´ 30ì´ˆ ì´ìƒìœ¼ë¡œ ë‚˜ì˜¤ê³ , ë©”ì‹œì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë³´ë‚´ì§€ì§€ ì•Šê±°ë‚˜ ì§€ì—°ë¨**

```bash
Message sent successfully in 30007 ms: Hello, Kafka!
```

**ì´ì™€ ë™ì‹œì—, Kafka í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ ë°œìƒ**

```bash
Disconnecting from node 0 due to request timeout
```

**ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„¤ì •ëœ ì‹œê°„ ì•ˆì— ë¸Œë¡œì»¤ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í•˜ë©´ ì—°ê²°ì„ ëŠìŒ**

## **5. ì›ì¸ ğŸ”**

1. **íƒ€ì„ì•„ì›ƒ ì„¤ì •**
    - ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„¤ì •ëœ ì‹œê°„ ë‚´ì— ì‘ë‹µì„ ë°›ì§€ ëª»í•˜ë©´ ì—°ê²°ì„ ëŠê³  `DisconnectException`ì´ ë°œìƒí•¨
    - ex. `request.timeout.ms`ê°€ 30ì´ˆë¼ë©´, 30ì´ˆ ë‚´ì— ì‘ë‹µì´ ì—†ìœ¼ë©´ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•¨
2. **ë„¤íŠ¸ì›Œí¬ ì§€ì—°**
    - ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ë‚˜ ë¸Œë¡œì»¤ ì‘ë‹µ ì§€ì—°ì´ í´ ê²½ìš° íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•¨
3. **ë¸Œë¡œì»¤ ì‘ë‹µ ë¶ˆê°€**
    - ë¸Œë¡œì»¤ê°€ ë‹¤ìš´ë˜ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì‘ë‹µì´ ì—†ìœ¼ë©´ `DisconnectException`ì´ ë°œìƒí•¨

## **6. í•´ê²° ë°©ì•ˆ ğŸ’¡**

1. **íƒ€ì„ì•„ì›ƒ ê°’ ì¡°ì •**
    - íƒ€ì„ì•„ì›ƒ ê°’ì„ ëŠ˜ë ¤ì„œ ì¼ì‹œì ì¸ ì§€ì—°ì„ í—ˆìš©í•  ìˆ˜ ìˆìŒ
    - ì˜ˆ: `request.timeout.ms` ê°’ì„ ëŠ˜ë¦¬ê¸°
2. **ë„¤íŠ¸ì›Œí¬ ì•ˆì •ì„± í™•ë³´**
    - ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì„ ìµœì†Œí™”í•˜ê³  ì•ˆì •ì ì¸ ì—°ê²°ì„ ìœ ì§€í•´ì•¼ í•¨
3. **ìë™ ì¬ì—°ê²° ì„¤ì •**
    - `retries`, `reconnect.backoff.ms` ë“±ì„ ì„¤ì •í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•˜ê²Œ í•  ìˆ˜ ìˆìŒ

## **7. íƒ€ì„ì•„ì›ƒ ê°’ ì¡°ì • (í•´ê²° ë°©ì•ˆ 1ë²ˆ) â²ï¸**

**`request.timeout.ms` 60ì´ˆë¡œ ëŠ˜ë¦¬ê³   `/sendMessage` ì—”ë“œí¬ì¸íŠ¸ ì¬í˜¸ì¶œ**

```yaml
request.timeout.ms: 600000
```

**ì˜ˆìƒê²°ê³¼**
- ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ 30ì´ˆë¼ê³  ê°€ì •í•˜ê³  ë¸Œë¡œì»¤ì˜ ì‘ë‹µ ì§€ì—° ì„ê³„ê°’ì„ 60ì´ˆë¡œ ì„¤ì •í–ˆìŒ
- íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ ë°œìƒì•ˆí•˜ì§€ ì•Šì„ê¹Œ..?

**ê¸°ëŒ€ì™€ ë‹¤ë¥¸ ê²°ê³¼**
- íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ ë°œìƒ

```bash
org.apache.kafka.common.errors.DisconnectException: null

Failed to send message to topic: my_topic. Exception: Topic my_topic not present in metadata after 60000 ms.
Failed message: Hello, Kafka!
Failed to send message in 60026 ms: org.springframework.kafka.KafkaException: Send failed
```

**ê¸°ëŒ€ì™€ ë‹¤ë¥¸ ê²°ê³¼ê°€ ë°œìƒí•œ ì›ì¸ ë¶„ì„ (ì¶”ì¸¡ ğŸ¤”)**

- **ë©”íƒ€ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨**
    - `Topic my_topic not present in metadata after 60000 ms`
      - í´ë¼ì´ì–¸íŠ¸ê°€ ë¸Œë¡œì»¤ë¡œë¶€í„° ìµœì‹  ë©”íƒ€ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ„
      - ì´ëŠ” ë¸Œë¡œì»¤ì™€ì˜ ì´ˆê¸° ì—°ê²° ë¬¸ì œë¡œ ë°œìƒí•  ìˆ˜ ìˆìŒ
- **íƒ€ì„ì•„ì›ƒ ê°’ì˜ í•œê³„**
    - íƒ€ì„ì•„ì›ƒ ê°’ì„ ëŠ˜ë ¤ë„ ë¸Œë¡œì»¤ ì—°ê²°ì´ë‚˜ ë©”íƒ€ë°ì´í„° ê°±ì‹  ìì²´ê°€ ì‹¤íŒ¨í•˜ë©´ ë¬¸ì œ í•´ê²° ë¶ˆê°€


## **8. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì•ˆì •ì„± í™•ë³´ (í•´ê²° ë°©ì•ˆ 2ë²ˆ) âœ…**

**ì§€ì—° ì œê±°**

```bash
root@6556e25e5562:/# tc qdisc del dev eth0 root netem
```

**postmanì„ í™œìš©í•´ `/sendMessage` ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ**

![postman](https://github.com/user-attachments/assets/027675fb-1099-48a4-8dd3-6ee65d4acb42)

**`Received message: Hello, Kafka!` ì‘ë‹µ íšë“**

![result5](https://github.com/user-attachments/assets/ee8ddeac-d8a4-4985-a8d7-c51b3409fd09)
