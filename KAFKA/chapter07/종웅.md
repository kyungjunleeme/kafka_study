# Chapter 7

---
### 신뢰성 보장
- 아파치 카프카가 보장하는 내용 (대표적인 예시로 RDBMS 에 ACID)
  - 파티션 메세지 순서 보장
  - ISR 에 전부 쓰여진 뒤에야 커밋으로 간주
  - 작동 레플리카가 최소 1개라도 있으면 메세지는 유실되지 않음
  - 커밋된 메세지만 읽음
---
### 복제
- 파티션별 다수 레플리카를 유지한다는 특성은 카프카 신뢰성 보장의 핵심
  - 인-싱크 레플리카 조건
    - 주키퍼와 활성 세션이 존재 - 기본 설정(6초)
    - 리더 최근 메세지 복제 - 기본 설정(10초)
    - 랙이 없었던 시간 - 기본 설정(10초)
      - 랙이란? 
      - 토픽의 오프셋(LOG_END_OFFSET)과 컨슈머 오프셋(CURRENT_OFFSET) 간의 차이
      - 모니터링 시 중요한 지표 - 처리량, 파티션 에 따른 장애를 조기 진단 할 수 있음
      ```
      - 처리량 이슈
      프로듀서의 데이터량이 늘어날 경우에는 컨슈머 랙이 늘어날 수 있다. 이 경우 파티션 갯수와 컨슈머 갯수를 늘려 병렬처리량을 늘려 컨슈머 랙을 줄일 수 있다.
      컨슈머의 갯수를 2개로 늘림으로써 컨슈머의 데이터 처리량을 2배로 늘릴 수 있다.
      - 파티션 이슈
      프로듀서의 데이터량이 일정함에도 불구하고 컨슈머의 장애로 인해 컨슈머 랙이 증가할 수도 있다. 컨슈머는 파티션 갯수만큼 늘려서 병렬처리하며 파티션마다 컨슈머가 할당되어 데이터를 처리한다.
      프로듀서가 보내는 데이터량은 일정한데 파티션 1번의 컨슈머 랙이 늘어나는 상황이 발생한다면 1번 파티션에 할당된 컨슈머에 이슈가 발생했음을 유추할 수 있다.
      ```
---
### 브로커 설정
- 복제 팩터
  - 토픽 단위 설정 - replication.factor
  - 브로커 단위 설정 - defualt.replication.factor
  - 가용성과 하드웨어 트레이드오프를 고려 할만한 사항
  - 저자는 5개의 사항을 주요 고려사항으로 이야기한다.
    - 가용성
      - 레플리카가 하나인 파티션은 재시작만 해도 작동 불능에 빠짐
      - ISR 이 보장되지 않으면 파티션은 사용불가
    - 지속성
      - ISR 이 보장되지 않은 상태일 시 메세지 유실 가능성이 커짐
    - 처리량
      - 레플리카가 늘어남에 따라 네트워크 처리량이 많아짐
    - 중단지연
      - ISR 에 전부 쓰여진 뒤 컨슈머가 읽을 수 있기에 컨슈머 속도 하락도 고려
    - 비용
      - 네트워크, 저장소 코스트 문제
---
### 언클린 리더 선출
- 가용할 수 있는 인-싱크 레플리카가 없을 때 아웃-싱크 레플리카를 리더로 선출하는 옵션
- 기존 리더 파티션의 오프셋을 따르지 않기 때문에 언클린 리더가 선출되면 메세지 유실의 위험도를 감수 해야함

---
### 최소 인-싱크 레플리카
- 파티션에 쓸 수 있는 상태를 조정하는 옵션
- 해당 옵션이 3으로 구성되면 인-싱크 레플리카가 3개 이상이 되어야 파티션에 쓸 수 있는 것 
```
만약 레플리카가 3개로 구성된 상태에서 인-싱크 레플리카를 3개 이상으로 인자를 준다면
하나의 레플리카가 오프라인 상태가 되었을 시 온라인으로 전환되기까지 해당 파티션은 쓰기요청을 받을 수 없음
```
---
### 디스크에 저장하기
- 디스크에 저장되지 않은 메세지도 응답하여 페이지 캐시를 이용한다.
- 즉 재시작을 제외한 평소 운용 상태에서는 flush.messages, flush.ms 옵션에 따라 페이지 캐시 공간을 활용하다
- 해당 옵션 기준에 따라 디스크로 저장된다.

---
### 프로듀서 설정

### Acks 설정
- acks=0
  - 메시지 전송 직후 성공 메세지 반환
  - 지연시간이 낮으며 메세지 유실 가능성이 상승한다.
- acks=1
  - 리더가 메시지를 수신 후 응답
  - 리더 파티션 오프라인 시 데이터 유실 가능
- acks=all
  - 모든 ISR가 메세지를 복제한 뒤 성공 응답
  - 메세지 유실 가능성은 적지만 레이턴시가 증가한다

### 재시도 설정
- 재시도 설정
  - `retries=INT.MAX_VALUE`: 무한 재시도.
    - acks 설정에 따라 브로커 측 송신이 되었음에도 재시도를 통한 메세지 중복이 가능함
    - 네트워크 문제에 따라 정상 수신된 메세지를 중복으로 보낼 가능성이 있음
  - `delivery.timeout.ms`: 최대 대기 시간 설정.

---

### 컨슈머 설정
- group.id
  - 그룹 id를 통해 토픽을 분산해서 처리함 (`default_group_id`)
- auto.offset.reset
  - 오프셋을 찾을 수 없을 떄 메세지 소비 시점 지정
  - `earliest`,`latest`
- enable.auto.commit
  - `true` : 자동 커밋
  - `false` : 수동 커밋

### 명시적 오프셋 커밋
- 커밋 시점 조정
  - 메세지 처리가 완료된 이후 커밋을 통해 데이터 유실을 방지 할 수 있다
  - 커밋 빈도를 설정 시 성능과 신뢰성 간에 트레이드오프 고려를 하여 설정하여야 한다.

## Refrerence
- https://zave7.github.io/kafka/Kafka-023-%EC%BB%A8%EC%8A%88%EB%A8%B8-%EB%9E%99
