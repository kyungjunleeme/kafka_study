### chapter.13 카프카 모니터링하기

**JMX(Java Management Extensions)**
- 카프카의 지표값을 관리하는 인터페이스
- 원격 JMX 은 기본 값이 off (외부 모니터링 시스템과 연계 시 설정)
- 외부 메트릭 수집 에이전트
  - `Naios Xi`: [`check_jmx`, `jmxtrans`]
- 내부 메트릭 수집 에전트
  - `Jolokia`, `MX4J`

**비 애플리케이션 지표**
- **애플리케이션 지표** : 카프카 JMX 지표
- **로그** : 카프카 발생, 구조화 - 텍스트 데이터
- **인프라스트럭처 지표** : LoadBalancer 위치에서 발생하는 지표
- **특수 클라이언트 지표** : 외부 시스템에서 발생하는 지표 (외부모니터링 툴)
- **일반 클라이언트 지표** : 카프카 클라이언트로 부터 발생

```
다양한 모니터링 시스템을 위치한 아키텍쳐에선 필요하지 않을 수 있지만
특수 클라이언트를 두어 외부 클라이언트에서 발생한 지표를 수집하여 웹서버의 상태를 간접적으로 모니터링 할 수 있다.
```

**지표 수집 주기에 따른 목적성**
- **경보** : 짧은 시간에 반복적인 수집, 명확한 목표가 있는 지표만 수집
- **디버깅** : 긴 시간에 걸쳐 수집

**서비스 수준 정의**
- **서비스 수준 지표**(service-level indicator, SLI) : 전체 이벤트에 대한 성공 이벤트 비율로 측정
- **서비스 수준 목표**(service-level threshold, SLT) : SLI 에 명확한 목표치를 결합한 지표로 측정
- **서비스 수준 협약**(service-level agreement, SLA) : SLA 은 여러개의 SLO 를 포함하여 측정 방식, 보고 방식, 지원 방식, 책임이 명시됨

**SLI 측정지표**
- Latency 처리량 : 빠른 응답
- Quality 질 : 정확히 전송되었는지
- Security 보안 : 전송 중 암호화 되었는지 권한에 대한 요소가 있는지
- Throughput 처리량 : 충분한 속도로 받을 수 있는지

**SLO 를 경보에 사용하는 방식**
- 일정기간에 소진율을 SLO 로 잡는다고 가정 
- 모니터링 함으로써 SLO 기준치를 충족하는 방식

**클러스터 문제 진단**
- **클러스터 과적재** : 클러스터 균형이 잡혀있으나 높은 지연,  요청 핸들러 풀 유휴 비율이 높을 때 진단 
  - 클러스터 요청 트래픽 제한 혹은 브로커 증설로 회피
- **컨트롤러 장애** : 활성 컨트롤러 수 , 컨트롤러 큐 를 모니터링함으로써 진단

**불완전 복제 파티션**
- `JMX MBean`: UnderReplicatedPartitions
-  **클러스터 성능** : 복제 파티션 수 등락, 수는 동일 오프라인 브로커 미존재 시 진단할 수 있음
  - Unbalanced load (부하 불균형)
  - **부하 불균형 진단 지표**
    - 파티션 갯수
    - 리더 파티션 수
    - 토픽 I/O
  - Resource exhausion(자원 고갈)
  - **자원 고갈 진단 지표**
    - CPU 사용률
    - 네트워크 I/O
    - 디스크 대기 시간
    - 디스크 가용률
- **호스트 수준 문제**
- cpu 성능 확인 : dmesg 툴 사용
- 디스크 성능 확인 : SAMRT, 온보드 캐시 지표 확인
- 네트워크 성능 확인 : 네트워크 인터페이스 에러 수 확인

**브로커 지표**
- 활성 컨트롤러 수 
  - `JMX MBean`: ActiveControllerCount
- 컨트롤러 큐 크기 : 브로커 처리를 기다리는 요청 수
  - `JMX MBean`: EventQueueSize
  - 컨트롤러 재할당으로 회피
- 요청 핸들러 유휴 비율 : 네트워크 스레드 풀과 요청 핸들러 스레드 풀 간의 유휴 비율
  - `JMX MBean`: RequestHandlerAvgIdlePercent
  - 요청 핸들러의 수는 시스템의 프로세서 수와 같아야함
- 전 토픽 바이트 인입 : 브로커 인입 지표
  - `JMX MBean`: BytesInPerSec
- 전 토픽 바이트 유출 : 브로커 인출 지표
  - `JMX MBean`: BytesOutPerSec

**클라이언트 모니터링**
- 프로듀서 지표
  - `record-error-rate`: 메세지 누수를 확인하는 지표 (정상 : 0)
  - `request-latency-avg` : 쓰기 요청을 받을 때 까지 걸린 평균 시간
  - `request-rate` : 브로커로 전달되는 쓰기 요청의 수 (단위 : sec)
  - `request-size-avg`,`batch-size-avg`,`record-size-avg` : 쓰기요청 평균 사이즈 , 메세지 배치 평균사이즈, 레코드 평균 사이즈
- 컨슈머 지표
  - 읽기 매니저
    - `bytes-consumed-rate`, `records-consumed-rate` : 메세지 처리량 
    -  `fetch-size-avg`: 메세지 사이즈

**컨슈머 코디네이터 지표**
- 컨슈머 그룹 동기화 작업으로 인해 일시 중지 될 수 있음
- `sync-time-avg`:  동기화 작업시간
- `sync-rate`:  초당 그룹 동기화 수
- `commit-latency-avg` : 오프셋 커밋에 걸린 시간
- `assigned-partitions`: 컨슈머 그룹 전체에게 밸런싱이 잘 되어 있는지 확인하는 지표

**쿼터**
- 기본 값으로 비활성화
- 쓰로틀링에 따른 결과 지표 확인
- **컨슈머**
  - `type: consumer-fetch-manager-metrics`
- **프로듀서**
  - `type : producer-metircs`

**랙 모니터링** 
- 컨슈머 모니터링 시 중요한 포인트
- 컨슈머 랙은 특정 파티션에 마지막으로 쓴 메세지와 컨슈머가 마지막으로 읽고 처리한 메세지 사이 차이
```
컨슈머 랙 확인 시 문제점
1. 컨슈머가 정상동작을 상정함
2. 하나의 파티션에 대한 랙만 보여줌
```
- 위와 같은 한계점이 존재하여, 외부 프로세스를 Burrow 를 활용하여 records-lag-max 지표를 모니터링 하는 방안

**종단 모니터링**

- 클라이언트 요청에 카프카가 정상 동작하는가? 에 관점에서 모니터링이 필요함
-  Xinfa Monitor 라는 외부 툴을 활용하여 클라이언트 정상 동작 모니터링 가능
- 관리자용 트래픽을 전체 브로커에게 전달함으로써 테스트를 진행 함
