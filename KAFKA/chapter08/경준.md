# ì¹´í”„ì¹´ì—ì„œ 'ì •í™•íˆ í•œ ë²ˆ' ë©”ì‹œì§€ ì „ë‹¬ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ ë°©ë²•

## ë©±ë“±ì  í”„ë¡œë“€ì„œ

ë©±ë“±ì  í”„ë¡œë“€ì„œëŠ” ë™ì¼í•œ ë©”ì‹œì§€ê°€ ì¤‘ë³µ ì²˜ë¦¬ë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.

### ì‘ë™ ì›ë¦¬
- ê° ë©”ì‹œì§€ì— ê³ ìœ í•œ í”„ë¡œë“€ì„œ IDì™€ ì‹œí€€ìŠ¤ ë„˜ë²„ë¥¼ ë¶€ì—¬í•˜ì—¬ ì¤‘ë³µì„ íƒì§€í•©ë‹ˆë‹¤.
- ë¸Œë¡œì»¤ëŠ” ê° íŒŒí‹°ì…˜ë³„ë¡œ ìµœê·¼ 5ê°œì˜ ë©”ì‹œì§€ë¥¼ ì¶”ì í•˜ì—¬ ì¤‘ë³µ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
- í”„ë¡œë“€ì„œ ì¬ì‹œì‘ ì‹œ ìƒˆë¡œìš´ í”„ë¡œë“€ì„œ IDê°€ í• ë‹¹ë˜ì–´ ì´ì „ ìƒíƒœì™€ êµ¬ë¶„ë©ë‹ˆë‹¤.
- ë¸Œë¡œì»¤ ì¥ì•  ì‹œì—ë„ ì¸ë©”ëª¨ë¦¬ ìƒíƒœê°€ ë³µì œë˜ì–´ ì¤‘ë³µ ë°©ì§€ê°€ ìœ ì§€ë©ë‹ˆë‹¤.

### í•œê³„
- í”„ë¡œë“€ì„œ ë‚´ë¶€ ë¡œì§ì— ì˜í•œ ì¬ì‹œë„ì—ë§Œ ì¤‘ë³µ ë°©ì§€ê°€ ì ìš©ë©ë‹ˆë‹¤.
- ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë‘ ë²ˆ ì „ì†¡í•˜ëŠ” ê²½ìš°ì—ëŠ” ì¤‘ë³µì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì‚¬ìš©ë²•
- í”„ë¡œë“€ì„œ ì„¤ì •ì—ì„œ `enable.idempotence=true`ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- `acks=all` ì„¤ì • ì‹œ ì„±ëŠ¥ ì €í•˜ ì—†ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## íŠ¸ëœì­ì…˜

íŠ¸ëœì­ì…˜ì€ ì½ê¸°-ì²˜ë¦¬-ì“°ê¸° íŒ¨í„´ì—ì„œ 'ì •í™•íˆ í•œ ë²ˆ' ì²˜ë¦¬ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

### í•´ê²°í•˜ëŠ” ë¬¸ì œ
1. ë ˆì½”ë“œ ì²˜ë¦¬ í›„ ì˜¤í”„ì…‹ ì»¤ë°‹ ì „ì— í¬ë˜ì‹œê°€ ë°œìƒí•˜ì—¬ ì¤‘ë³µ ì²˜ë¦¬ê°€ ë˜ëŠ” ë¬¸ì œ.
2. ë ˆì½”ë“œ ì½ê¸° ì§í›„ í¬ë˜ì‹œ ë°œìƒ ì‹œ ë‹¤ë¥¸ ì»¨ìŠˆë¨¸ì— ì˜í•œ ì¤‘ë³µ ì²˜ë¦¬ ë¬¸ì œ.

### ì‘ë™ ë°©ì‹
1. **ì›ìì  ë‹¤ìˆ˜ íŒŒí‹°ì…˜ ì“°ê¸°**
   - íŠ¸ëœì­ì…˜ì  í”„ë¡œë“€ì„œë¥¼ í†µí•´ ì—¬ëŸ¬ íŒŒí‹°ì…˜ì— ëŒ€í•œ ì“°ê¸°ë¥¼ ì›ìì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
   - `transactional.id`ë¥¼ ì„¤ì •í•˜ì—¬ í”„ë¡œë“€ì„œ ì¬ì‹œì‘ ì‹œì—ë„ ë™ì¼í•œ IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
2. **ì¢€ë¹„ íœì‹±**
   - ì¬ì‹œì‘ëœ í”„ë¡œë“€ì„œì˜ ì´ì „ ì¸ìŠ¤í„´ìŠ¤(ì¢€ë¹„)ê°€ ì“°ê¸°ë¥¼ ìˆ˜í–‰í•˜ì§€ ëª»í•˜ë„ë¡ ì—í¬í¬ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì°¨ë‹¨í•©ë‹ˆë‹¤.
3. **ì»¨ìŠˆë¨¸ ê²©ë¦¬ ìˆ˜ì¤€**
   - `isolation.level=read_committed`ë¡œ ì„¤ì •í•˜ì—¬ ì»¤ë°‹ëœ ë©”ì‹œì§€ë§Œ ì½ë„ë¡ í•©ë‹ˆë‹¤.

### í•œê³„
1. ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ ì¤‘ ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ì˜ ìƒí˜¸ì‘ìš©ì—ì„œ ë°œìƒí•˜ëŠ” ë¶€ì‘ìš©.
2. ì¹´í”„ì¹´ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¡œì˜ ë°ì´í„° ì €ì¥ ì‹œ ì›ìì  ì²˜ë¦¬ê°€ ì–´ë ¤ìš´ ê²½ìš°.
3. í´ëŸ¬ìŠ¤í„° ê°„ ë°ì´í„° ë³µì œ ì‹œ íŠ¸ëœì­ì…˜ ì •ë³´ê°€ ì „ë‹¬ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ.
4. ë°œí–‰/êµ¬ë… íŒ¨í„´ì—ì„œ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ì™„ì „íˆ ë°©ì§€í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°.

### ì‚¬ìš©ë²•
- ì¹´í”„ì¹´ ìŠ¤íŠ¸ë¦¼ì¦ˆ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” `processing.guarantee=exactly_once`ë¡œ ì„¤ì •í•˜ì—¬ ìë™ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
- ì§ì ‘ íŠ¸ëœì­ì…˜ APIë¥¼ ì‚¬ìš©í•  ê²½ìš°, `KafkaProducer`ì˜ `beginTransaction`, `commitTransaction` ë©”ì„œë“œë¥¼ í™œìš©í•©ë‹ˆë‹¤.
- í”„ë¡œë“€ì„œì— `transactional.id`ë¥¼ ì„¤ì •í•˜ê³ , `initTransactions()`ë¥¼ í˜¸ì¶œí•œ í›„, `sendOffsetsToTransaction` ë©”ì„œë“œë¡œ ì˜¤í”„ì…‹ì„ ì»¤ë°‹í•˜ì—¬ ì›ìì  ì²˜ë¦¬ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

---

ìœ„ì˜ ë°©ë²•ë“¤ì„ í™œìš©í•˜ì—¬ ì¹´í”„ì¹´ì—ì„œ 'ì •í™•íˆ í•œ ë²ˆ' ë©”ì‹œì§€ ì „ë‹¬ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


25.01.20
- ê²½ì¤€ ë‹¤ì‹œ ì •ë¦¬ì¤‘
https://rudaks.tistory.com/entry/spring-kafka%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%A0-%EB%95%8C%EC%9D%98-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%B2%98%EB%A6%AC
ì—¬ê¸° ë‚˜ì˜¨ ë‚´ìš© ë‹¤ì‹œ ì‚´í´ ë³¼ ê²ƒ

- https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html
- https://westlife0615.tistory.com/607
- https://github.com/confluentinc/librdkafka/issues/2414
- https://www.confluent.io/blog/debug-apache-kafka-reduced-message-throughput/
- https://www.confluent.io/blog/5-common-pitfalls-when-using-apache-kafka/
- https://www.confluent.io/blog/streaming-etl-with-confluent-kafka-message-routing-and-fan-out/
- https://www.confluent.io/blog/kafka-python-asyncio-integration/



ì„±íƒë‹˜ ë³´ì¶© ë‚´ìš©

- EventLoopëŠ” ìš´ì˜ì²´ì œì— ë”°ë¼ NIO, Epoll, KQueue ë“± ì—¬ëŸ¬ ë°©ì‹ì„ ì§€ì›
- https://chatgpt.com/share/678f4a34-1d5c-8009-9756-9fb5831466ad
- https://www.confluent.io/blog/streaming-etl-with-confluent-kafka-message-routing-and-fan-out/


https://jun10920.tistory.com/48
https://imksh.com/129
https://www.confluent.io/blog/debug-apache-kafka-reduced-message-throughput/
https://jsyeo.tistory.com/entry/%EC%98%AC%EB%A6%AC%EB%B8%8C%EC%98%81-%EC%98%A8%EB%9D%BC%EC%9D%B8-%EC%87%BC%ED%95%91%EB%AA%B0-public-cloudAWS-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%B6%95-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8?category=1217581


p.207(í•œêµ­ì±…) <> p.183(ì›ì„œ)
```markdown
What if a broker receives a sequence number that is unexpectedly high? The broker
expects message number 2 to be followed by message number 3; what happens if the
broker receives message number 27 instead? In such cases the broker will respond
with an â€œout of order sequenceâ€ error, but if we use an idempotent producer without
using transactions, this error can be ignored.
While the producer will continue normally after encountering an
â€œout of order sequence numberâ€ exception, this error typically indiâ€
cates that messages were lost between the producer and the
brokerâ€”if the broker received message number 2 followed by mesâ€
sage number 27, something must have happened to messages 3 to
26. When encountering such an error in the logs, it is worth revisitâ€
ing the producer and topic configuration and making sure the proâ€
ducer is configured with recommended values for high reliability
and to check whether unclean leader election has occurred.
As is always the case with distributed systems, it is interesting to consider the behavâ€
ior of an idempotent producer under failure conditions. Consider two cases: proâ€
ducer restart and broker failure.
```
-> 

```java
     } else if (error == Errors.OUT_OF_ORDER_SEQUENCE_NUMBER) {
         if (!hasUnresolvedSequence(batch.topicPartition) &&
                 (batch.sequenceHasBeenReset() || !isNextSequence(batch.topicPartition, batch.baseSequence()))) {
             // We should retry the OutOfOrderSequenceException if the batch is _not_ the next batch, ie. its base
             // sequence isn't the lastAckedSequence + 1.
             return true;
         } else if (!isTransactional()) {
             // For the idempotent producer, retry all OUT_OF_ORDER_SEQUENCE_NUMBER errors. If there are no
             // unresolved sequences, or this batch is the one immediately following an unresolved sequence, we know
             // there is actually a gap in the sequences, and we bump the epoch. Otherwise, retry without bumping
             // and wait to see if the sequence resolves
             if (!hasUnresolvedSequence(batch.topicPartition) ||
                     isNextSequenceForUnresolvedPartition(batch.topicPartition, batch.baseSequence())) {
                 requestIdempotentEpochBumpForPartition(batch.topicPartition);
             }
             return true;
         }
     }
```


```java
    synchronized TransactionalRequestResult initializeTransactions(ProducerIdAndEpoch producerIdAndEpoch) {
        maybeFailWithError();

        boolean isEpochBump = producerIdAndEpoch != ProducerIdAndEpoch.NONE;
        return handleCachedTransactionRequestResult(() -> {
            // If this is an epoch bump, we will transition the state as part of handling the EndTxnRequest
            if (!isEpochBump) {
                transitionTo(State.INITIALIZING);
                log.info("Invoking InitProducerId for the first time in order to acquire a producer ID");
            } else {
                log.info("Invoking InitProducerId with current producer ID and epoch {} in order to bump the epoch", producerIdAndEpoch);
            }
            InitProducerIdRequestData requestData = new InitProducerIdRequestData()
                    .setTransactionalId(transactionalId)
                    .setTransactionTimeoutMs(transactionTimeoutMs)
                    .setProducerId(producerIdAndEpoch.producerId)
                    .setProducerEpoch(producerIdAndEpoch.epoch);
            InitProducerIdHandler handler = new InitProducerIdHandler(new InitProducerIdRequest.Builder(requestData),
                    isEpochBump);
            enqueueRequest(handler);
            return handler.result;
        }, State.INITIALIZING, "initTransactions");
    }
```

```markdown
Producer IDê°€ ì—†ëŠ” ê²½ìš° (isEpochBump == false)

ìƒˆë¡œìš´ Producer IDë¥¼ ìš”ì²­ (InitProducerId ìš”ì²­).
í”„ë¡œë“€ì„œ ìƒíƒœë¥¼ INITIALIZINGìœ¼ë¡œ ë³€ê²½.
ì´ë¯¸ Producer IDê°€ ìˆëŠ” ê²½ìš° (isEpochBump == true)

Epochë§Œ ì¦ê°€ì‹œí‚¤ëŠ” ìš”ì²­ì„ ë³´ëƒ„.
íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œë§ˆë‹¤ Epochì„ ì¦ê°€ì‹œì¼œ ì¤‘ë³µ ë°©ì§€.
```

208-ë³µêµ¬ê³¼ì •
209-



p.221 -> 

Preventing zombie instances of the application from creating duplicates requires a
mechanism for zombie fencing, or preventing zombie instances of the application
from writing results to the output stream. The usual way of fencing zombiesâ€”using
an epochâ€”is used here. Kafka increments the epoch number associated with a
transactional.id when initTransaction() is invoked to initialize a transactional
producer. Send, commit, and abort requests from producers with the same
transactional.id but lower epochs will be rejected with the FencedProducer error.
The older producer will not be able to write to the output stream and will be forced to
close(), preventing the zombie from introducing duplicate records. In Apache Kafka
2.5 and later, there is also an option to add consumer group metadata to the transacâ€
tion metadata. This metadata will also be used for fencing, which will allow producers
with different transactional IDs to write to the same partitions while still fencing
against zombie instances?  ã…Œ  .

ì™œ ì´ëŸ°ê²Œ í•„ìš”í•´ ? ì´ë¯¸ ë‹¤ë¥¸ê±¸  -> ì„¸ì¢…ë‹˜ ì§ˆë¬¸



LSO(Last Stable Offset)
Figure 8-2. Consumers in read_committed mode will lag behind consumers with default
configuration


isoloation_level ì„¤ì • -> Consumer ì„¤ì •
- https://rudaks.tistory.com/entry/spring-kafka%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%A0-%EB%95%8C%EC%9D%98-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%B2%98%EB%A6%AC
- 

ì¹´í”„ì¹´ë¥¼ ê³µë¶€í•˜ê¸°ì— ì–´ë ¤ìš´ ì 
- ì„¤ì •ì´ ì–´ë–¤ ì„¤ì •ì— ì ìš©í•´ì•¼í•˜ëŠ” ì§€ í—·ê°ˆë¦°ë‹¤.  # ì¢…ì›…ë‹˜ì´ë‘ ì°¾ì•„ë³¸ê±° ìˆìŒ



Our simple stream processing job will have exactly-once guarantees on its output
even if the input was written nontransactionally. The atomic multipartition produce
guarantees that if the output records were committed to the output topic, the offset of
the input records was also committed for that consumer, and as a result the input
records will not be processed again.


An important pattern to avoid is publishing a message and then
waiting for another application to respond before committing the
transaction. The other application will not receive the message
until after the transaction was committed, resulting in a deadlock.

https://firststep-de.tistory.com/41

ì°¸ê³ í•´ì„œ ê°™ì´ ì½ê¸°



consumer group ì„¸ëŒ€
https://cwiki.apache.org/confluence/display/KAFKA/KIP-848%3A+The+Next+Generation+of+the+Consumer+Rebalance+Protocol


```markdown
ğŸ” Kafkaì˜ Consumer Groupê³¼ Partition Assignment ë¬¸ì œ
ğŸ”¥ Kafka Consumer Groupì˜ ê¸°ë³¸ ë™ì‘
Kafkaì˜ **ì»¨ìŠˆë¨¸ ê·¸ë£¹(Consumer Group)**ì—ì„œëŠ” ì—¬ëŸ¬ ê°œì˜ ì»¨ìŠˆë¨¸ê°€ ë™ì¼í•œ í† í”½ì˜ íŒŒí‹°ì…˜ì„ ë‚˜ëˆ ì„œ ì½ìŒ.
ì»¨ìŠˆë¨¸ ê·¸ë£¹ì—ì„œ ì»¨ìŠˆë¨¸ê°€ ì¶”ê°€ë˜ê±°ë‚˜ ì œê±°ë  ë•Œ, KafkaëŠ” ìë™ìœ¼ë¡œ **ë¦¬ë°¸ëŸ°ìŠ¤(rebalance)**ë¥¼ ìˆ˜í–‰í•˜ì—¬ íŒŒí‹°ì…˜ì„ ì¬í• ë‹¹í•©ë‹ˆë‹¤.
âŒ Rebalanceë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¬¸ì œ
ê¸°ì¡´ì— íŒŒí‹°ì…˜ 0ì„ ì½ë˜ ì»¨ìŠˆë¨¸ê°€ ë¦¬ë°¸ëŸ°ìŠ¤ë¡œ ì¸í•´ ë‹¤ë¥¸ ì»¨ìŠˆë¨¸ì—ê²Œ í• ë‹¹ë˜ë©´?
ê°™ì€ í‚¤ë¥¼ ê°€ì§„ ë°ì´í„°ê°€ ë‹¤ë¥¸ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡ë  ê°€ëŠ¥ì„±ì´ ìƒê¹€.
ì´ë ‡ê²Œ ë˜ë©´ Kafka Streamsì—ì„œ State Storeì˜ ì •í•©ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ.


```

https://easywritten.com/post/kafka-message-delivery-semantics/

# EOS êµ¬í˜„
https://github.com/confluentinc/confluent-kafka-python/blob/master/examples/eos-transactions.py



# ì´ ì‚¬ëŒì´ ì •ë¦¬ë¥¼ ì œì¼ ì˜í•¨
https://whitepro.tistory.com/1039
https://developer.confluent.io/courses/architecture/transactions/
https://easywritten.com/post/kafka-message-delivery-semantics/
