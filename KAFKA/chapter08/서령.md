# Chapter 08. '정확히 한 번 ' 의미 구조

- Apache Kafka에서 '정확히 한 번(Exactly Once)' 의미는 두 가지 핵심 기능, 멱등적 프로듀서(idempotent producer)와 트랜잭션(transaction)의 조합으로 이루어져 있습니다.

## **8.1 멱등적 프로듀서**

- 멱등적 프로듀서는 동일한 메시지를 여러 번 전송하더라도, Kafka 브로커가 이를 중복으로 처리하지 않고 한 번만 기록하도록 보장합니다.
1. UPDATE t SET x=x+1 where y=5  
2. UPDATE t SET x=18 where y=5

- 1은 멱등적이지 않고, 2는 멱등적이다.

#### 1. 프로듀서 재시작
- 프로듀서에 장애가 발생할 경우, 보통 새 프로듀서를 생성해서 장애가 난 프로듀서를 대체한다.
- 
#### 2. 브로커 장애

### **8.1.1 멱등적 프로듀서의 작동 원리**

### **8.1.2 멱등적 프로듀서의 한계**


## **8.2 트랜잭션**

- Kafka에서 트랜잭션은 스트림 처리 애플리케이션의 **데이터 정확성**과 **일관성**을 보장하기 위해 도입된 주요 기능이다.
- Kafka는 **정확히 한 번 처리**(Exactly Once Semantics, EOS)를 구현하여 스트림 처리 중 데이터 중복이나 손실을 방지하고 안정성을 제공합니다. 

### **8.2.1 트랜잭션 활용 사례**

- 스트림 처리 애플리케이션은 데이터 집적(aggregation)이나 조인(join)에 많이 활용됨.
- 이 과정에서 누락된 데이터나 중복된 데이터가 발생하면 분석 결과가 왜곡될 수 있음.
- 트랜잭션은 이러한 복잡한 연산 중에도 데이터 정확성을 유지함.

- Kafka 트랜잭션의 주요 특징
  - 원자성(Atomicity)
    - 트랜잭션 내에서 이루어진 모든 작업(읽기, 쓰기, 업데이트 등)은 전부 성공하거나 전부 실패함.
    - 부분적으로 처리된 데이터 상태는 발생하지 않음.
  
  - 중복 없는 처리(Exactly Once Semantics, EOS)
    - Kafka 트랜잭션은 데이터를 중복없이 처리하므로, 동일한 메시지가 여러 번 기록되거나 처리되지 않음.
  
  - 멀티 파티션 및 멀티 토픽 지원
    - 트랜잭션은 하나의 프로듀서가 여러 파티션 및 주제에 걸쳐 작업할 때도 원자성을 유지함.
  
  - 장애 복구
    - 트랜잭션 도중 장애가 발생하면 롤백(rollback)을 통해 잘못된 상태를 복구함.

### **8.2.2 트랜잭션이 해결하는 문제**

- 원본 토픽으로부터 이벤트를 읽어서 처리한 다음, 결과를 다른 토픽에 쓴다. 
- 우리가 처리하는 각 메시지에 대해 결과가 정확히 한번만 쓰여지도록 하고 싶은데, 무엇이 잘못될 수 있을까?  

1. 애플리케이션 크래시로 인한 재처리
  - Kafka는 기본적으로 at-least-once 메시지 처리 방식을 사용하여 데이터 손실을 방지하지만 중복 데이터 발생 가능성을 있음. <br /><br /> 

  - 처리 순서
    1. 컨슈머는 입력 메시지를 읽고 처리함.
    2. 결과를 출력 토픽에 쓰고 나서, 입력 메시지의 오프셋을 커밋함. <br /><br /> 
    
    
  - 이 순서에서 출력 토픽에 쓰기 완료 후 오프셋 커밋 전에 컨슈머가 크래시되면 다음과 같은 상황이 발생함
    1. Kafka는 해당 오프셋이 커밋되지 않았다고 판단
    2. 새 Consumer가 마지막 커밋된 오프셋부터 다시 데이터를 읽음.
    3. 이미 처리된 데이터가 다시 읽히고, 동일한 결과가 출력 토픽에 기록됨. <br /><br /> 
    
  - Kafka의 트랜잭션 기능을 활용하여 다음 작업을 원자적으로 수행하여 해결할 수 있음.
    1. 출력 토픽에 데이터 쓰기
    2. 입력 메시지의 오프셋 커밋
  
2. 좀비 애플리케이션에 의해 발생하는 재처리


### **8.2.3 트랜잭션은 어떻게 '정확히 한 번'을 보장하는가?**

- '정확히 한 번'처리라 함은 이러한 읽기, 처리, 쓰기 작업이 **원자적으로** 이루어진다는 의미다.
-  카프카 트랜잭션은 **원자적 다수 파티션 쓰기 기능**을 도입.
- **원자적 다수 파티션 쓰기 기능**: 결과는 출력 토픽에, 오프셋은 _consumer_offsets 토픽에 쓰여지는 것을 말함.
- 트랜잭션을 사용해서 원자적 다수 파티션 쓰기를 수행하려면 트랜잭션 프로듀서를 사용해야 함.
  - 트랜잭션 프로듀서: transactional.id 설정이 잡혀있고, initTransactions()를 호출해서 초기화해줌. 
  - transactional.id는 재시작 후에도 동일한 프로듀서를 식별하는 것. 
  - 

- 좀비 인스턴스: 분산 시스템에서 주로 발생하는 문제로, 특정 애플리케이션 인스턴스가 더이상 유효하지 않거나 장애가 발생했음에도 불구하고, 여전히 작동하는 것처럼 보이며 데이터를 잘못 처리하거나 시스템의 일관성을 해칠 수 있는 상황
- 좀비펜싱: 좀비 인스턴스가 잘못된 작업을 하지 못하도록 방지하는 기법. 에포크(epoch)기반 펜싱 방법 사용됨.
- 에포크(epoch) 기반 좀비 펜싱
  - 카프카의 트랜잭션 프로듀서는 에포크 기반 좀비 펜싱을 기본적으로 지원함.
  - 카프카에서 트랜잭션을 사용하는 경우, 각 트랜잭셔널 프로듀서에는 고유한 트랙잭션 id와 함께 내부적으로 증가하는 에포크 번호가 사용됨.

- 
  